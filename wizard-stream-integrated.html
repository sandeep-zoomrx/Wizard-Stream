<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ferma Agents - New Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }

    /* Wizard styles */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideOutLeft { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-100%); } }

    .wizard-card { animation: fadeInUp 0.35s ease; }
    .pill-animate { animation: scaleIn 0.2s ease; }
    .slide-in-right { animation: slideInRight 0.4s ease-out forwards; }
    .slide-out-left { animation: slideOutLeft 0.4s ease-out forwards; }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

    .light-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); }
    .light-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ============================================
    // ICONS
    // ============================================
    const Check = ({ size = 16, className = "", strokeWidth = 2 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="20 6 9 17 4 12" />
      </svg>
    );

    const Pencil = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
      </svg>
    );

    const Play = ({ size = 16, className = "", fill = "none" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polygon points="5 3 19 12 5 21 5 3" />
      </svg>
    );

    const Download = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
    );

    const Send = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="22" y1="2" x2="11" y2="13" />
        <polygon points="22 2 15 22 11 13 2 9 22 2" />
      </svg>
    );

    const ChevronRight = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="9 18 15 12 9 6" />
      </svg>
    );

    const CollapsePanelLeftIcon = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="3" y="3" width="18" height="18" rx="4" />
        <line x1="9" y1="3" x2="9" y2="21" />
      </svg>
    );

    const CollapsePanelRightIcon = ({ size = 16, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="3" y="3" width="18" height="18" rx="4" />
        <line x1="15" y1="3" x2="15" y2="21" />
      </svg>
    );

    // ============================================
    // DESIGN TOKENS
    // ============================================
    const ACCENT = '#7B61FF';
    const accentBg = { backgroundColor: ACCENT };

    const darkBgPattern = {
      backgroundColor: '#0a0a0b',
      backgroundImage: 'radial-gradient(rgba(123, 97, 255, 0.08) 1px, transparent 1px)',
      backgroundSize: '16px 16px',
    };

    const type = {
      xs: { fontSize: '10px', lineHeight: '13px' },
      sm: { fontSize: '11px', lineHeight: '15px' },
      base: { fontSize: '11px', lineHeight: '15px' },
      md: { fontSize: '12px', lineHeight: '15px' },
      lg: { fontSize: '13px', lineHeight: '17px' },
      xl: { fontSize: '13px', lineHeight: '17px' },
      '2xl': { fontSize: '13px', lineHeight: '17px' },
    };

    // ============================================
    // CONFIGURATION DATA
    // ============================================
    const allWorkflows = [
      { id: 'market-landscape', name: 'Landscape Research', teams: ['BD', 'CI', 'Medical', 'Other'] },
      { id: 'catalyst-monitoring', name: 'Catalyst Tracking', teams: ['BD', 'CI', 'Medical', 'Other'] },
      { id: 'trial-readout', name: 'Trial Readouts', teams: ['BD', 'CI', 'Medical', 'Other'] },
      { id: 'custom', name: 'Custom', teams: ['BD', 'CI', 'Medical', 'Other'] }
    ];

    const enrichmentConfig = {
      science: {
        label: 'Science',
        items: [
          { id: 'mechanism', label: 'Mechanism', teams: ['BD', 'CI', 'Medical', 'Other'], workflows: ['market-landscape', 'trial-readout', 'custom'] },
          { id: 'efficacy', label: 'Efficacy', teams: ['BD', 'CI', 'Medical', 'Other'], workflows: ['market-landscape', 'trial-readout', 'custom'] },
          { id: 'safety', label: 'Safety', teams: ['BD', 'CI', 'Medical', 'Other'], workflows: ['market-landscape', 'trial-readout', 'custom'] }
        ]
      },
      development: {
        label: 'Development',
        items: [
          { id: 'stage', label: 'Stage', teams: ['BD', 'CI', 'Medical', 'Other'], workflows: ['market-landscape', 'catalyst-monitoring', 'trial-readout', 'custom'] },
          { id: 'trials', label: 'Trials', teams: ['BD', 'CI', 'Medical', 'Other'], workflows: ['market-landscape', 'trial-readout', 'custom'] },
          { id: 'regulatory', label: 'Regulatory', teams: ['BD', 'CI', 'Medical', 'Other'], workflows: ['market-landscape', 'catalyst-monitoring', 'custom'] },
          { id: 'ip', label: 'IP', teams: ['BD', 'CI', 'Other'], workflows: ['market-landscape', 'catalyst-monitoring', 'custom'] }
        ]
      },
      commercial: {
        label: 'Commercial',
        items: [
          { id: 'market', label: 'Market', teams: ['BD', 'CI', 'Other'], workflows: ['market-landscape', 'custom'] },
          { id: 'competition', label: 'Competition', teams: ['BD', 'CI', 'Medical', 'Other'], workflows: ['market-landscape', 'catalyst-monitoring', 'custom'] },
          { id: 'access', label: 'Access', teams: ['BD', 'CI', 'Other'], workflows: ['market-landscape', 'custom'] },
          { id: 'sales', label: 'Sales', teams: ['BD', 'CI', 'Other'], workflows: ['market-landscape', 'custom'] }
        ]
      },
      corporate: {
        label: 'Corporate',
        items: [
          { id: 'guidance', label: 'Guidance', teams: ['BD', 'CI', 'Other'], workflows: ['market-landscape', 'catalyst-monitoring', 'custom'] },
          { id: 'deals', label: 'Deals', teams: ['BD', 'CI', 'Other'], workflows: ['market-landscape', 'catalyst-monitoring', 'custom'] }
        ]
      }
    };

    const workflowAlerts = {
      'market-landscape': { description: 'Competitive field changes.', alerts: ['Pipeline Entry', 'Approval', 'Deal', 'Discontinuation'] },
      'catalyst-monitoring': { description: 'Binary events.', alerts: ['Data Readout', 'Regulatory Decision', 'Trial Milestone'] },
      'trial-readout': { description: 'Trial-level events.', alerts: ['Data Readout', 'Protocol Change', 'Enrollment Complete'] },
      'custom': { description: 'All event types.', alerts: ['Data Readout', 'Regulatory Decision', 'Approval', 'Deal', 'Discontinuation', 'Pipeline Entry', 'Patent Event', 'Label Change', 'Guideline Update'] }
    };

    const deliverablesConfig = {
      format: {
        label: 'Format',
        items: [
          { id: 'executive-brief', label: 'Executive Brief', workflows: ['market-landscape', 'catalyst-monitoring', 'trial-readout', 'custom'] },
          { id: 'deep-dives', label: 'Deep Dives', workflows: ['market-landscape', 'catalyst-monitoring', 'trial-readout', 'custom'] },
          { id: 'data-tables', label: 'Data Tables', workflows: ['market-landscape', 'catalyst-monitoring', 'trial-readout', 'custom'] }
        ]
      },
      cadence: {
        label: 'Cadence',
        items: [
          { id: 'on-demand', label: 'On-Demand', workflows: ['market-landscape', 'catalyst-monitoring', 'trial-readout', 'custom'] },
          { id: 'weekly', label: 'Weekly', workflows: ['market-landscape', 'catalyst-monitoring', 'trial-readout', 'custom'] },
          { id: 'monthly', label: 'Monthly', workflows: ['market-landscape', 'catalyst-monitoring', 'trial-readout', 'custom'] }
        ]
      }
    };

    const foundationDefaults = {
      BD: {
        'market-landscape': 'Oncology licensing opportunities, Phase 2+, differentiated MOA. Focus on mid-cap biotechs with partnership-ready assets.',
        'catalyst-monitoring': 'Autoimmune assets with upcoming readouts or PDUFA dates. IL-17, TYK2, JAK pathways.',
        'trial-readout': 'CDK4/6 inhibitor trials in breast cancer. Need efficacy/safety comparison for diligence.',
        'custom': 'CNS licensing opportunities—depression, schizophrenia, Alzheimer\'s. Phase 1-3.'
      },
      CI: {
        'market-landscape': 'GLP-1 competitive landscape. Lilly, Novo, Amgen, plus emerging players. Approved products and late-stage pipeline.',
        'catalyst-monitoring': 'Oncology catalysts from Pfizer, BMS, Merck. Readouts, approvals, label expansions.',
        'trial-readout': 'PD-1/L1 combos in 1L NSCLC. Keytruda, Opdivo, Tecentriq. How do they compare?',
        'custom': 'Immunology competitive set. Humira biosimilars, IL-23s, JAKs. Track share shifts and pipeline.'
      },
      Medical: {
        'market-landscape': 'Atopic dermatitis treatments. IL-4/13, JAK, OX40 mechanisms. Approved and Phase 2+.',
        'catalyst-monitoring': 'Derm congress presentations (AAD, EADV) and guideline updates. Key publications.',
        'trial-readout': 'JAK inhibitor long-term safety in AD. MACE, VTE, malignancy signals.',
        'custom': 'Gene therapy and ERT in lysosomal storage disorders. Early and late-stage.'
      },
      Other: {
        'market-landscape': 'Biosimilar landscape in oncology supportive care. G-CSF, ESA products.',
        'catalyst-monitoring': 'Regulatory actions—inspections, labeling updates, warning letters.',
        'trial-readout': 'Real-world evidence studies. Effectiveness and adherence outcomes.',
        'custom': 'Market access developments. ICER reviews, payer decisions, pricing actions.'
      }
    };

    const workflowShortNames = {
      'market-landscape': 'Landscape',
      'catalyst-monitoring': 'Catalysts',
      'trial-readout': 'Readout',
      'custom': 'Custom'
    };

    // Scope blocks configuration
    const scopeBlocksConfig = [
      { id: 'drug', label: 'Drug', placeholder: 'e.g., Semaglutide, Tirzepatide, Retatrutide' },
      { id: 'company', label: 'Company', placeholder: 'e.g., Novo Nordisk, Eli Lilly, Pfizer' },
      { id: 'target', label: 'Target', placeholder: 'e.g., GLP-1, GIP, GIPR, GCG' },
      { id: 'indication', label: 'Indication', placeholder: 'e.g., Type 2 Diabetes, Obesity, NASH' },
      { id: 'devPhase', label: 'Development Phase', placeholder: 'e.g., Phase 2, Phase 3, Approved' },
      { id: 'disease', label: 'Disease', placeholder: 'e.g., Obesity, Diabetes, Cardiovascular' },
      { id: 'therapyArea', label: 'Therapy Area', placeholder: 'e.g., Metabolic, Oncology, CNS' },
      { id: 'geography', label: 'Geography', placeholder: 'e.g., US, EU, Japan, Global' }
    ];

    // ============================================
    // TOOLTIP COMPONENT
    // ============================================
    const Tooltip = ({ children, label }) => (
      <div className="relative group">
        {children}
        <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 px-2 py-1 bg-black text-white text-xs font-medium rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
          {label}
        </div>
      </div>
    );

    // ============================================
    // WIZARD COMPONENT
    // ============================================
    function Wizard({ config, setConfig, onComplete, minimized }) {
      const [editingNote, setEditingNote] = useState(null);
      const [noteInput, setNoteInput] = useState('');
      const [addingCustom, setAddingCustom] = useState(null);
      const [customInput, setCustomInput] = useState('');
      const [activeScopeBlock, setActiveScopeBlock] = useState(null);
      const [scopeInput, setScopeInput] = useState('');

      const getStep = () => {
        if (!config.team) return 1;
        if (!config.workflow) return 2;
        if (!config.foundationApproved) return 3;
        if (!config.enrichmentApproved) return 4;
        if (!config.alertsApproved) return 5;
        if (!config.reportsApproved) return 6;
        return 7;
      };

      const currentStep = getStep();

      const getWorkflowName = () => allWorkflows.find(w => w.id === config.workflow)?.name || '';
      const getWorkflowsForTeam = (team) => allWorkflows.filter(wf => wf.teams.includes(team));
      const getAlertsForWorkflow = (workflowId) => workflowAlerts[workflowId] || { description: '', alerts: [] };

      const getEnrichmentCategories = () => {
        const { team, workflow } = config;
        if (!team || !workflow) return [];
        const categories = [];
        for (const [key, category] of Object.entries(enrichmentConfig)) {
          const filteredItems = category.items.filter(item => item.teams.includes(team) && item.workflows.includes(workflow));
          if (filteredItems.length > 0) categories.push({ key, label: category.label, items: filteredItems });
        }
        return categories;
      };

      const getDeliverablesCategories = () => {
        if (!config.workflow) return [];
        return Object.entries(deliverablesConfig).map(([key, category]) => ({
          key,
          label: category.label,
          items: category.items.filter(item => item.workflows.includes(config.workflow))
        })).filter(cat => cat.items.length > 0);
      };

      const isEnrichmentSelected = (itemId) => config.enrichment.some(e => e.id === itemId);
      const getEnrichmentNote = (itemId) => config.enrichment.find(e => e.id === itemId)?.note || '';
      const isDeliverableSelected = (itemId) => config.deliverables.some(d => d.id === itemId);

      const selectTeam = (team) => {
        setConfig({
          team,
          workflow: null,
          foundation: '',
          scope: {},
          entities: { firm: [], drug: [], trial: [] },
          enrichment: [],
          customEnrichment: {},
          alerts: [],
          customAlerts: [],
          alertNotes: {},
          deliverables: [],
          deliverablesScope: '',
          agentName: '',
          foundationApproved: false,
          enrichmentApproved: false,
          alertsApproved: false,
          reportsApproved: false
        });
        setActiveScopeBlock(null);
        setScopeInput('');
      };

      const selectWorkflow = (workflowId) => {
        setConfig(prev => ({
          ...prev,
          workflow: workflowId,
          foundation: '',
          scope: {},
          enrichment: [],
          customEnrichment: {},
          alerts: [],
          customAlerts: [],
          alertNotes: {},
          deliverables: [],
          deliverablesScope: '',
          agentName: '',
          foundationApproved: false,
          enrichmentApproved: false,
          alertsApproved: false,
          reportsApproved: false
        }));
        setActiveScopeBlock(null);
        setScopeInput('');
      };

      // Scope block handlers
      const isScopeBlockSelected = (blockId) => config.scope[blockId]?.selected || false;
      const getScopeBlockValues = (blockId) => config.scope[blockId]?.values || [];

      const toggleScopeBlock = (blockId) => {
        const isSelected = isScopeBlockSelected(blockId);
        if (isSelected) {
          // If already selected, just open/toggle the input panel (don't deselect)
          if (activeScopeBlock === blockId) {
            // Close the panel if clicking the same block
            setActiveScopeBlock(null);
            setScopeInput('');
          } else {
            // Open the panel for this block
            setActiveScopeBlock(blockId);
            setScopeInput('');
          }
        } else {
          // Select block and open input
          setConfig(prev => ({
            ...prev,
            scope: { ...prev.scope, [blockId]: { selected: true, values: [] } }
          }));
          setActiveScopeBlock(blockId);
          setScopeInput('');
        }
      };

      const deselectScopeBlock = (blockId) => {
        setConfig(prev => {
          const newScope = { ...prev.scope };
          delete newScope[blockId];
          return { ...prev, scope: newScope };
        });
        if (activeScopeBlock === blockId) {
          setActiveScopeBlock(null);
          setScopeInput('');
        }
      };

      const addScopeValue = (blockId) => {
        const trimmed = scopeInput.trim();
        if (!trimmed) return;
        const values = trimmed.split(',').map(v => v.trim()).filter(v => v);
        setConfig(prev => ({
          ...prev,
          scope: {
            ...prev.scope,
            [blockId]: {
              selected: true,
              values: [...new Set([...(prev.scope[blockId]?.values || []), ...values])]
            }
          }
        }));
        setScopeInput('');
      };

      const removeScopeValue = (blockId, value) => {
        setConfig(prev => ({
          ...prev,
          scope: {
            ...prev.scope,
            [blockId]: {
              ...prev.scope[blockId],
              values: (prev.scope[blockId]?.values || []).filter(v => v !== value)
            }
          }
        }));
      };

      const handleScopeCsvUpload = (file) => {
        if (!file || !activeScopeBlock) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const lines = text.split('\n').map(line => line.trim()).filter(line => line);
          const startIndex = lines[0]?.toLowerCase().includes('name') || lines[0]?.toLowerCase().includes('id') ? 1 : 0;
          const newValues = lines.slice(startIndex).filter(v => v);
          setConfig(prev => ({
            ...prev,
            scope: {
              ...prev.scope,
              [activeScopeBlock]: {
                selected: true,
                values: [...new Set([...(prev.scope[activeScopeBlock]?.values || []), ...newValues])]
              }
            }
          }));
        };
        reader.readAsText(file);
      };

      const downloadScopeCsvTemplate = () => {
        const block = scopeBlocksConfig.find(b => b.id === activeScopeBlock);
        const sampleData = ['Name', block?.placeholder?.replace('e.g., ', '').split(', ')[0] || 'Item 1', 'Item 2', 'Item 3'].join('\n');
        const blob = new Blob([sampleData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${activeScopeBlock}-template.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      };

      const getScopeCount = () => {
        return Object.values(config.scope).reduce((acc, block) => acc + (block.values?.length || 0), 0);
      };

      const getScopeSummary = () => {
        const selected = Object.entries(config.scope).filter(([_, v]) => v.selected && v.values?.length > 0);
        if (selected.length === 0) return 'No scope defined';
        return selected.map(([id, data]) => {
          const block = scopeBlocksConfig.find(b => b.id === id);
          return `${data.values.length} ${block?.label || id}`;
        }).join(', ');
      };

      const toggleEnrichment = (itemId) => {
        const exists = config.enrichment.some(e => e.id === itemId);
        if (exists) {
          setConfig(prev => ({ ...prev, enrichment: prev.enrichment.filter(e => e.id !== itemId) }));
        } else {
          setConfig(prev => ({ ...prev, enrichment: [...prev.enrichment, { id: itemId }] }));
        }
      };

      const toggleAlert = (item) => {
        if (config.alerts.includes(item)) {
          setConfig(prev => ({ ...prev, alerts: prev.alerts.filter(i => i !== item) }));
        } else {
          setConfig(prev => ({ ...prev, alerts: [...prev.alerts, item] }));
        }
      };

      const toggleDeliverable = (itemId) => {
        const exists = config.deliverables.some(d => d.id === itemId);
        if (exists) {
          setConfig(prev => ({ ...prev, deliverables: prev.deliverables.filter(d => d.id !== itemId) }));
        } else {
          setConfig(prev => ({ ...prev, deliverables: [...prev.deliverables, { id: itemId }] }));
        }
      };

      const generateAgentName = () => {
        const { team, workflow, scope } = config;
        if (!team || !workflow) return '';

        // Try to get a meaningful name from scope
        const companyValues = scope.company?.values || [];
        const drugValues = scope.drug?.values || [];
        const therapyValues = scope.therapyArea?.values || [];
        const indicationValues = scope.indication?.values || [];

        if (companyValues.length === 1) return `${companyValues[0]} ${workflowShortNames[workflow]}`;
        if (drugValues.length === 1) return `${drugValues[0]} Tracker`;
        if (therapyValues.length === 1) return `${therapyValues[0]} ${workflowShortNames[workflow]}`;
        if (indicationValues.length === 1) return `${indicationValues[0]} ${workflowShortNames[workflow]}`;
        if (companyValues.length > 1) return `${companyValues.length} Companies ${workflowShortNames[workflow]}`;

        return `${team} ${workflowShortNames[workflow]}`;
      };

      // When reaching step 7, trigger onComplete
      useEffect(() => {
        if (currentStep === 7 && !config.agentName) {
          setConfig(prev => ({ ...prev, agentName: generateAgentName() }));
        }
      }, [currentStep]);

      if (minimized) {
        return (
          <div className="w-16 h-full flex flex-col items-center py-6 border-r border-white/10" style={darkBgPattern}>
            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={accentBg}>
              <Check size={20} className="text-white" />
            </div>
            <div className="mt-4 text-white/40 text-xs text-center writing-mode-vertical" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>
              {config.agentName || 'New Agent'}
            </div>
          </div>
        );
      }

      return (
        <div className="h-full flex flex-col overflow-hidden" style={darkBgPattern}>
          <div className="flex-1 overflow-auto px-6 py-8">
            <h1 className="text-xl font-semibold text-white mb-8">New Agent</h1>

            {/* Step 1: Team */}
            {currentStep > 1 ? (
              <div className="flex items-center gap-3 px-4 py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl mb-3">
                <span className="w-2 h-2 bg-green-500 rounded-full shadow-lg shadow-green-500/40" />
                <span className="text-xs font-medium text-white/50 w-20 uppercase tracking-wide">Team</span>
                <span className="text-sm font-medium text-white flex-1">{config.team}</span>
                <button onClick={() => selectTeam(null)} className="text-xs text-white/40 hover:text-white">Change</button>
              </div>
            ) : (
              <div className="wizard-card bg-white/[0.02] border border-white/[0.08] rounded-xl p-5 mb-3">
                <div className="flex items-center gap-3 mb-4">
                  <span className="w-7 h-7 bg-white/10 rounded-lg flex items-center justify-center text-xs font-semibold text-white">1</span>
                  <span className="text-sm font-semibold text-white">Select Your Team</span>
                </div>
                <div className="flex gap-2">
                  {['BD', 'CI', 'Medical', 'Other'].map(t => (
                    <button key={t} onClick={() => selectTeam(t)}
                      className="flex-1 h-11 bg-white/[0.04] border border-white/[0.08] rounded-lg text-sm font-medium text-white hover:bg-white/[0.08] hover:border-white/[0.15] transition-all">
                      {t}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Step 2: Workflow */}
            {currentStep > 2 ? (
              <div className="flex items-center gap-3 px-4 py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl mb-3">
                <span className="w-2 h-2 bg-green-500 rounded-full shadow-lg shadow-green-500/40" />
                <span className="text-xs font-medium text-white/50 w-20 uppercase tracking-wide">Workflow</span>
                <span className="text-sm font-medium text-white flex-1">{getWorkflowName()}</span>
                <button onClick={() => setConfig(prev => ({ ...prev, workflow: null, foundationApproved: false, enrichmentApproved: false, alertsApproved: false, reportsApproved: false }))} className="text-xs text-white/40 hover:text-white">Change</button>
              </div>
            ) : currentStep === 2 ? (
              <div className="wizard-card bg-white/[0.02] border border-white/[0.08] rounded-xl p-5 mb-3">
                <div className="flex items-center gap-3 mb-4">
                  <span className="w-7 h-7 bg-white/10 rounded-lg flex items-center justify-center text-xs font-semibold text-white">2</span>
                  <span className="text-sm font-semibold text-white">Choose a Workflow</span>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  {getWorkflowsForTeam(config.team).map(wf => (
                    <button key={wf.id} onClick={() => selectWorkflow(wf.id)}
                      className="h-11 px-4 bg-white/[0.04] border border-white/[0.08] rounded-lg text-xs font-medium text-white text-left hover:bg-white/[0.08] hover:border-white/[0.15] transition-all">
                      {wf.name}
                    </button>
                  ))}
                </div>
              </div>
            ) : (
              <div className="flex items-center gap-3 px-4 py-3 border border-white/[0.04] rounded-xl mb-3 opacity-40">
                <span className="w-7 h-7 bg-white/[0.04] rounded-lg flex items-center justify-center text-xs font-semibold text-white/50">2</span>
                <span className="text-sm font-medium text-white/50">Choose a Workflow</span>
              </div>
            )}

            {/* Step 3: Define Scope */}
            {currentStep > 3 ? (
              <div className="flex items-center gap-3 px-4 py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl mb-3">
                <span className="w-2 h-2 bg-green-500 rounded-full shadow-lg shadow-green-500/40" />
                <span className="text-xs font-medium text-white/50 w-20 uppercase tracking-wide">Scope</span>
                <span className="text-sm font-medium text-white flex-1 truncate">{getScopeSummary()}</span>
                <button onClick={() => { setConfig(prev => ({ ...prev, foundationApproved: false, enrichmentApproved: false, alertsApproved: false, reportsApproved: false, agentName: '' })); setActiveScopeBlock(null); }} className="text-xs text-white/40 hover:text-white">Change</button>
              </div>
            ) : currentStep === 3 ? (
              <div className="wizard-card bg-white/[0.02] border border-white/[0.08] rounded-xl p-5 mb-3">
                <div className="flex items-center gap-3 mb-4">
                  <span className="w-7 h-7 bg-white/10 rounded-lg flex items-center justify-center text-xs font-semibold text-white">3</span>
                  <span className="text-sm font-semibold text-white">Define Scope</span>
                </div>
                <p className="text-xs text-white/50 mb-4">Select the dimensions you want to track and add specific items.</p>

                {/* Scope Block Pills */}
                <div className="flex flex-wrap gap-2 mb-4">
                  {scopeBlocksConfig.map(block => {
                    const isSelected = isScopeBlockSelected(block.id);
                    const values = getScopeBlockValues(block.id);
                    const hasValues = values.length > 0;
                    const isActive = activeScopeBlock === block.id;
                    return (
                      <div key={block.id} className="relative">
                        <button onClick={() => toggleScopeBlock(block.id)}
                          className={`h-8 px-3 rounded-lg text-xs font-medium transition-all flex items-center gap-2 ${
                            isSelected
                              ? isActive ? 'bg-white text-black ring-2 ring-white/30' : 'bg-white text-black'
                              : 'bg-white/[0.04] border border-white/[0.06] text-white/70 hover:bg-white/[0.08]'
                          }`}>
                          {block.label}
                          {hasValues && (
                            <span className={`text-xs px-1.5 py-0.5 rounded ${isSelected ? 'bg-black/10' : 'bg-white/10'}`}>
                              {values.length}
                            </span>
                          )}
                        </button>
                        {isSelected && (
                          <button
                            onClick={(e) => { e.stopPropagation(); deselectScopeBlock(block.id); }}
                            className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-xs leading-none"
                          >
                            ×
                          </button>
                        )}
                      </div>
                    );
                  })}
                </div>

                {/* Active Block Input Section */}
                {activeScopeBlock && (
                  <div className="border border-white/[0.08] rounded-xl p-4 mb-4 bg-white/[0.02]">
                    <div className="flex items-center justify-between mb-3">
                      <span className="text-xs font-semibold text-white">
                        {scopeBlocksConfig.find(b => b.id === activeScopeBlock)?.label}
                      </span>
                      <button onClick={() => { setActiveScopeBlock(null); setScopeInput(''); }} className="text-xs text-white/40 hover:text-white">
                        Close
                      </button>
                    </div>

                    {/* Display existing values as tags */}
                    {getScopeBlockValues(activeScopeBlock).length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-3">
                        {getScopeBlockValues(activeScopeBlock).map((value, idx) => (
                          <span key={idx} className="inline-flex items-center gap-1.5 h-7 px-2.5 bg-white/[0.06] border border-white/[0.08] rounded-md text-xs text-white/80">
                            {value}
                            <button onClick={() => removeScopeValue(activeScopeBlock, value)} className="text-white/40 hover:text-red-400 text-sm leading-none">×</button>
                          </span>
                        ))}
                      </div>
                    )}

                    {/* Input field */}
                    <div className="flex gap-2 mb-3">
                      <input
                        type="text"
                        value={scopeInput}
                        onChange={(e) => setScopeInput(e.target.value)}
                        onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); addScopeValue(activeScopeBlock); } }}
                        placeholder={scopeBlocksConfig.find(b => b.id === activeScopeBlock)?.placeholder}
                        className="flex-1 h-9 px-3 bg-white/[0.02] border border-white/[0.08] rounded-lg text-xs text-white placeholder-white/30 focus:outline-none focus:border-white/20"
                      />
                      <button onClick={() => addScopeValue(activeScopeBlock)}
                        className="h-9 px-4 bg-white text-black rounded-lg text-xs font-medium hover:bg-white/90 transition-all">
                        Add
                      </button>
                    </div>

                    {/* CSV Upload */}
                    <div className="flex gap-2">
                      <label className="flex-1 h-9 px-3 border border-dashed border-white/15 rounded-lg text-xs font-medium bg-white/[0.02] text-white/50 cursor-pointer hover:bg-white/[0.04] hover:border-white/25 transition-all flex items-center justify-center gap-2">
                        <span>Upload CSV</span>
                        <input type="file" accept=".csv" className="hidden" onChange={(e) => handleScopeCsvUpload(e.target.files?.[0])} />
                      </label>
                      <button onClick={downloadScopeCsvTemplate}
                        className="h-9 px-3 border border-dashed border-white/15 rounded-lg text-xs font-medium bg-white/[0.02] text-white/50 hover:bg-white/[0.04] hover:border-white/25 transition-all">
                        Template
                      </button>
                    </div>
                  </div>
                )}

                <button onClick={() => setConfig(prev => ({ ...prev, foundationApproved: true }))}
                  disabled={getScopeCount() === 0}
                  className="w-full h-11 mt-2 bg-white text-black rounded-lg text-sm font-medium hover:bg-white/90 transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                  Continue
                </button>
              </div>
            ) : (
              <div className="flex items-center gap-3 px-4 py-3 border border-white/[0.04] rounded-xl mb-3 opacity-40">
                <span className="w-7 h-7 bg-white/[0.04] rounded-lg flex items-center justify-center text-xs font-semibold text-white/50">3</span>
                <span className="text-sm font-medium text-white/50">Define Scope</span>
              </div>
            )}

            {/* Step 4: Enrichment */}
            {currentStep > 4 ? (
              <div className="flex items-center gap-3 px-4 py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl mb-3">
                <span className="w-2 h-2 bg-green-500 rounded-full shadow-lg shadow-green-500/40" />
                <span className="text-xs font-medium text-white/50 w-20 uppercase tracking-wide">Enrichment</span>
                <span className="text-sm font-medium text-white flex-1">{config.enrichment.length} Data Points</span>
                <button onClick={() => setConfig(prev => ({ ...prev, enrichmentApproved: false, alertsApproved: false, reportsApproved: false }))} className="text-xs text-white/40 hover:text-white">Change</button>
              </div>
            ) : currentStep === 4 ? (
              <div className="wizard-card bg-white/[0.02] border border-white/[0.08] rounded-xl p-5 mb-3">
                <div className="flex items-center gap-3 mb-4">
                  <span className="w-7 h-7 bg-white/10 rounded-lg flex items-center justify-center text-xs font-semibold text-white">4</span>
                  <span className="text-sm font-semibold text-white">Enrichment</span>
                </div>
                {getEnrichmentCategories().map(category => (
                  <div key={category.key} className="mb-5 last:mb-0">
                    <div className="text-xs font-semibold text-white/40 uppercase tracking-wider mb-2">{category.label}</div>
                    <div className="flex flex-wrap gap-2">
                      {category.items.map(item => (
                        <button key={item.id} onClick={() => toggleEnrichment(item.id)}
                          className={`h-8 px-3 rounded-lg text-xs font-medium transition-all ${
                            isEnrichmentSelected(item.id)
                              ? 'bg-white text-black'
                              : 'bg-white/[0.04] border border-white/[0.06] text-white/70 hover:bg-white/[0.08]'
                          }`}>
                          {item.label}
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
                <button onClick={() => setConfig(prev => ({ ...prev, enrichmentApproved: true }))}
                  disabled={config.enrichment.length === 0}
                  className="w-full h-11 mt-4 bg-white text-black rounded-lg text-sm font-medium hover:bg-white/90 transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                  Continue
                </button>
              </div>
            ) : (
              <div className="flex items-center gap-3 px-4 py-3 border border-white/[0.04] rounded-xl mb-3 opacity-40">
                <span className="w-7 h-7 bg-white/[0.04] rounded-lg flex items-center justify-center text-xs font-semibold text-white/50">4</span>
                <span className="text-sm font-medium text-white/50">Enrichment</span>
              </div>
            )}

            {/* Step 5: Alerts */}
            {currentStep > 5 ? (
              <div className="flex items-center gap-3 px-4 py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl mb-3">
                <span className="w-2 h-2 bg-green-500 rounded-full shadow-lg shadow-green-500/40" />
                <span className="text-xs font-medium text-white/50 w-20 uppercase tracking-wide">Alerts</span>
                <span className="text-sm font-medium text-white flex-1">{config.alerts.length > 0 ? `${config.alerts.length} Configured` : 'Skipped'}</span>
                <button onClick={() => setConfig(prev => ({ ...prev, alertsApproved: false, reportsApproved: false }))} className="text-xs text-white/40 hover:text-white">Change</button>
              </div>
            ) : currentStep === 5 ? (
              <div className="wizard-card bg-white/[0.02] border border-white/[0.08] rounded-xl p-5 mb-3">
                <div className="flex items-center gap-3 mb-4">
                  <span className="w-7 h-7 bg-white/10 rounded-lg flex items-center justify-center text-xs font-semibold text-white">5</span>
                  <span className="text-sm font-semibold text-white">Alerts</span>
                  <span className="ml-auto text-xs text-white/40 bg-white/[0.06] px-2 py-1 rounded">Optional</span>
                </div>
                <div className="flex flex-wrap gap-2 mb-4">
                  {getAlertsForWorkflow(config.workflow).alerts.map(alert => (
                    <button key={alert} onClick={() => toggleAlert(alert)}
                      className={`h-8 px-3 rounded-full text-xs font-medium transition-all ${
                        config.alerts.includes(alert)
                          ? 'bg-white text-black'
                          : 'bg-white/[0.04] border border-white/[0.06] text-white/70 hover:bg-white/[0.08]'
                      }`}>
                      {alert}
                    </button>
                  ))}
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setConfig(prev => ({ ...prev, alerts: [], alertNotes: {}, alertsApproved: true }))}
                    className="flex-1 h-11 bg-transparent border border-white/10 text-white/60 rounded-lg text-sm font-medium hover:bg-white/[0.04] transition-all">
                    Skip
                  </button>
                  <button onClick={() => setConfig(prev => ({ ...prev, alertsApproved: true }))}
                    disabled={config.alerts.length === 0}
                    className="flex-1 h-11 bg-white text-black rounded-lg text-sm font-medium hover:bg-white/90 transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                    Continue
                  </button>
                </div>
              </div>
            ) : (
              <div className="flex items-center gap-3 px-4 py-3 border border-white/[0.04] rounded-xl mb-3 opacity-40">
                <span className="w-7 h-7 bg-white/[0.04] rounded-lg flex items-center justify-center text-xs font-semibold text-white/50">5</span>
                <span className="text-sm font-medium text-white/50">Alerts</span>
                <span className="ml-auto text-xs text-white/30">Optional</span>
              </div>
            )}

            {/* Step 6: Deliverables */}
            {currentStep > 6 ? (
              <div className="flex items-center gap-3 px-4 py-3 bg-white/[0.03] border border-white/[0.06] rounded-xl mb-3">
                <span className="w-2 h-2 bg-green-500 rounded-full shadow-lg shadow-green-500/40" />
                <span className="text-xs font-medium text-white/50 w-20 uppercase tracking-wide">Reports</span>
                <span className="text-sm font-medium text-white flex-1">{config.deliverables.length > 0 ? `${config.deliverables.length} Selected` : 'Skipped'}</span>
                <button onClick={() => setConfig(prev => ({ ...prev, reportsApproved: false }))} className="text-xs text-white/40 hover:text-white">Change</button>
              </div>
            ) : currentStep === 6 ? (
              <div className="wizard-card bg-white/[0.02] border border-white/[0.08] rounded-xl p-5 mb-3">
                <div className="flex items-center gap-3 mb-4">
                  <span className="w-7 h-7 bg-white/10 rounded-lg flex items-center justify-center text-xs font-semibold text-white">6</span>
                  <span className="text-sm font-semibold text-white">Deliverables</span>
                  <span className="ml-auto text-xs text-white/40 bg-white/[0.06] px-2 py-1 rounded">Optional</span>
                </div>
                {getDeliverablesCategories().map(category => (
                  <div key={category.key} className="mb-4 last:mb-0">
                    <div className="text-xs font-semibold text-white/40 uppercase tracking-wider mb-2">{category.label}</div>
                    <div className="flex flex-wrap gap-2">
                      {category.items.map(item => (
                        <button key={item.id} onClick={() => toggleDeliverable(item.id)}
                          className={`h-8 px-3 rounded-lg text-xs font-medium transition-all ${
                            isDeliverableSelected(item.id)
                              ? 'bg-white text-black'
                              : 'bg-white/[0.04] border border-white/[0.06] text-white/70 hover:bg-white/[0.08]'
                          }`}>
                          {item.label}
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
                <div className="flex gap-2 mt-4">
                  <button onClick={() => setConfig(prev => ({ ...prev, reportsApproved: true }))}
                    className="flex-1 h-11 bg-transparent border border-white/10 text-white/60 rounded-lg text-sm font-medium hover:bg-white/[0.04] transition-all">
                    Skip
                  </button>
                  <button onClick={() => setConfig(prev => ({ ...prev, reportsApproved: true }))}
                    className="flex-1 h-11 bg-white text-black rounded-lg text-sm font-medium hover:bg-white/90 transition-all">
                    Continue
                  </button>
                </div>
              </div>
            ) : (
              <div className="flex items-center gap-3 px-4 py-3 border border-white/[0.04] rounded-xl mb-3 opacity-40">
                <span className="w-7 h-7 bg-white/[0.04] rounded-lg flex items-center justify-center text-xs font-semibold text-white/50">6</span>
                <span className="text-sm font-medium text-white/50">Deliverables</span>
                <span className="ml-auto text-xs text-white/30">Optional</span>
              </div>
            )}

            {/* Step 7: Final - Name and Create */}
            {currentStep === 7 && (
              <div className="wizard-card bg-white/[0.02] border border-white/[0.08] rounded-xl p-6 mt-4">
                <div className="text-xs font-semibold text-white/40 uppercase tracking-wider mb-3">Agent Name</div>
                <input
                  type="text"
                  value={config.agentName}
                  onChange={(e) => setConfig(prev => ({ ...prev, agentName: e.target.value }))}
                  placeholder="Enter agent name..."
                  className="w-full h-12 px-4 bg-white/[0.02] border border-white/10 rounded-lg text-base font-medium text-white placeholder-white/30 focus:outline-none focus:border-white/25 mb-4"
                />
                <button onClick={onComplete}
                  disabled={!config.agentName.trim()}
                  className="w-full h-12 bg-white text-black rounded-lg text-sm font-semibold hover:bg-white/90 transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                  Generate Plan
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================
    // PLAN PREVIEW PANEL
    // ============================================
    // Helper to generate objective description from config
    const generateObjectiveDescription = (config) => {
      const workflowName = allWorkflows.find(w => w.id === config.workflow)?.name || 'Custom';
      const scopeEntries = Object.entries(config.scope).filter(([_, v]) => v.selected && v.values?.length > 0);

      if (scopeEntries.length === 0) return `Conduct ${workflowName.toLowerCase()} analysis.`;

      // Build a readable objective
      const scopeParts = scopeEntries.map(([id, data]) => {
        const block = scopeBlocksConfig.find(b => b.id === id);
        const label = block?.label?.toLowerCase() || id;
        if (data.values.length === 1) return `${data.values[0]}`;
        if (data.values.length <= 3) return data.values.join(', ');
        return `${data.values.length} ${label}s`;
      });

      return `${workflowName} for ${scopeParts.join(' across ')}. Identify opportunities and track developments based on selected enrichment criteria.`;
    };

    // Get scope steps for the Data section
    const getScopeDataSteps = (scope) => {
      const entries = Object.entries(scope).filter(([_, v]) => v.selected && v.values?.length > 0);
      return entries.map(([id, data]) => {
        const block = scopeBlocksConfig.find(b => b.id === id);
        return {
          title: `Identify ${block?.label || id}`,
          description: data.values.join(', ')
        };
      });
    };

    // Get enrichment steps for the Data section
    const getEnrichmentDataSteps = (enrichment) => {
      return enrichment.map(e => {
        const allItems = Object.values(enrichmentConfig).flatMap(cat => cat.items);
        const item = allItems.find(i => i.id === e.id);
        return {
          title: `Analyze ${item?.label || e.id}`,
          description: `Gather and evaluate ${item?.label?.toLowerCase() || e.id} data for identified entities.`
        };
      });
    };

    function PlanPreview({ config, onExecute, onEditPlan }) {
      const [expandedSection, setExpandedSection] = useState(1);

      // Combine scope + enrichment into Data steps
      const dataSteps = [
        ...getScopeDataSteps(config.scope),
        ...getEnrichmentDataSteps(config.enrichment)
      ];

      // Transform wizard config into plan structure
      const planSections = [
        {
          title: 'Objective',
          steps: [
            { title: generateObjectiveDescription(config) }
          ]
        },
        {
          title: 'Data',
          steps: dataSteps.length > 0 ? dataSteps : [{ title: 'No data collection configured' }]
        },
        {
          title: 'Alerts',
          steps: config.alerts.length > 0 ? config.alerts.map(alert => ({
            title: `Monitor ${alert}`,
            description: `Track and alert on ${alert.toLowerCase()} events.`
          })) : [{ title: 'No alerts configured', description: 'Alerts were skipped during setup.' }]
        },
        {
          title: 'Reports',
          steps: config.deliverables.length > 0 ? config.deliverables.map(d => {
            const allItems = Object.values(deliverablesConfig).flatMap(cat => cat.items);
            const item = allItems.find(i => i.id === d.id);
            return {
              title: `Generate ${item?.label || d.id}`,
              description: `Create ${item?.label?.toLowerCase() || d.id} deliverables.`
            };
          }) : [{ title: 'No reports configured', description: 'Deliverables were skipped during setup.' }]
        }
      ];

      return (
        <div className="h-full flex flex-col slide-in-right" style={darkBgPattern}>
          {/* Header */}
          <div className="h-14 px-5 flex items-center justify-between border-b border-white/10">
            <span className="h-7 px-3 rounded text-white font-medium flex items-center" style={{ ...accentBg, ...type.sm }}>
              Generated Plan
            </span>
            <div className="flex items-center gap-2">
              <Tooltip label="Edit plan">
                <button onClick={onEditPlan} className="h-8 w-8 flex items-center justify-center text-white/60 hover:text-white hover:bg-white/10 rounded-lg transition-colors">
                  <Pencil size={15} />
                </button>
              </Tooltip>
            </div>
          </div>

          {/* Plan Content */}
          <div className="flex-1 overflow-auto py-4 px-5">
            <div className="mb-4">
              <h2 className="text-lg font-semibold text-white mb-1">{config.agentName}</h2>
              <p className="text-xs text-white/50">{config.team} • {allWorkflows.find(w => w.id === config.workflow)?.name}</p>
            </div>

            {planSections.map((section, sectionIndex) => {
              const isObjective = sectionIndex === 0;
              const isExpanded = isObjective || expandedSection === sectionIndex;
              const emptyMessages = ['No alerts configured', 'No reports configured', 'No data collection configured'];
              const hasContent = section.steps.length > 0 && !emptyMessages.includes(section.steps[0].title);

              return (
                <div key={sectionIndex} className="mb-4">
                  <div
                    className="flex items-center gap-2 mb-2 cursor-pointer hover:opacity-80"
                    onClick={() => !isObjective && setExpandedSection(isExpanded ? null : sectionIndex)}
                  >
                    {!isObjective && (
                      <ChevronRight size={12} className={`text-white/40 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                    )}
                    <span className="text-xs text-white/40 uppercase tracking-wider font-medium">{section.title}</span>
                    <div className="flex-1 h-px bg-white/10"></div>
                    {!isObjective && hasContent && (
                      <span className="text-xs text-white/30">{section.steps.length}</span>
                    )}
                  </div>

                  {isExpanded && section.steps.map((step, stepIndex) => (
                    <div key={stepIndex} className="flex gap-3 ml-1 mb-2">
                      {sectionIndex > 0 && hasContent && (
                        <div className="flex flex-col items-center">
                          <div className="flex-shrink-0 w-4 h-4 rounded-full flex items-center justify-center border border-white/20">
                            <div className="w-1.5 h-1.5 rounded-full bg-white/40"></div>
                          </div>
                          {stepIndex < section.steps.length - 1 && (
                            <div className="w-0.5 flex-1 my-1 bg-white/10"></div>
                          )}
                        </div>
                      )}
                      <div className="pb-2">
                        {step.description ? (
                          <>
                            <h4 className="text-xs font-medium text-white mb-0.5">{step.title}</h4>
                            <p className="text-xs text-white/50" style={{ lineHeight: '15px' }}>{step.description}</p>
                          </>
                        ) : (
                          <p className="text-xs text-white/80" style={{ lineHeight: '15px' }}>{step.title}</p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              );
            })}
          </div>

          {/* Execute Button */}
          <div className="p-5 border-t border-white/10">
            <button onClick={onExecute}
              className="w-full h-12 rounded-lg text-sm font-semibold text-white flex items-center justify-center gap-2 hover:opacity-90 transition-all"
              style={accentBg}>
              <Play size={16} fill="currentColor" />
              Execute Plan
            </button>
          </div>
        </div>
      );
    }

    // ============================================
    // STREAM VIEW (Full execution view)
    // ============================================
    function StreamView({ config }) {
      const [activeTab, setActiveTab] = useState('exec');
      const [chatInput, setChatInput] = useState('');
      const [planCollapsed, setPlanCollapsed] = useState(false);
      const [chatCollapsed, setChatCollapsed] = useState(false);
      const [expandedSection, setExpandedSection] = useState(1);

      // Combine scope + enrichment into Data steps
      const dataSteps = [
        ...getScopeDataSteps(config.scope),
        ...getEnrichmentDataSteps(config.enrichment)
      ];

      // Transform wizard config into plan structure
      const planSections = [
        {
          title: 'Objective',
          steps: [
            { title: generateObjectiveDescription(config) }
          ]
        },
        {
          title: 'Data',
          steps: dataSteps.length > 0 ? dataSteps : [{ title: 'No data collection configured' }]
        },
        {
          title: 'Alerts',
          steps: config.alerts.length > 0 ? config.alerts.map(alert => ({
            title: `Monitor ${alert}`,
            description: `Track and alert on ${alert.toLowerCase()} events.`
          })) : [{ title: 'No alerts configured', description: 'Alerts were skipped during setup.' }]
        },
        {
          title: 'Reports',
          steps: config.deliverables.length > 0 ? config.deliverables.map(d => {
            const allItems = Object.values(deliverablesConfig).flatMap(cat => cat.items);
            const item = allItems.find(i => i.id === d.id);
            return {
              title: `Generate ${item?.label || d.id}`,
              description: `Create ${item?.label?.toLowerCase() || d.id} deliverables.`
            };
          }) : [{ title: 'No reports configured', description: 'Deliverables were skipped during setup.' }]
        }
      ];

      return (
        <div className="h-full flex">
          {/* Left Sidebar - Plan */}
          <aside
            className={`flex flex-col flex-shrink-0 transition-all duration-300 ${planCollapsed ? 'w-10 pl-2 pr-1' : 'pl-4 pr-3'}`}
            style={{ ...darkBgPattern, width: planCollapsed ? undefined : '280px' }}
          >
            <div className={`h-12 mt-3 flex items-center flex-shrink-0 ${planCollapsed ? 'justify-center' : 'justify-between'}`}>
              {!planCollapsed && (
                <span className="h-7 px-3 rounded text-white font-medium flex items-center" style={{ ...accentBg, ...type.sm }}>
                  Plan
                </span>
              )}
              <div className="flex items-center gap-1">
                {!planCollapsed && (
                  <>
                    <Tooltip label="Edit plan">
                      <button className="h-7 w-7 flex items-center justify-center text-white hover:opacity-70">
                        <Pencil size={15} />
                      </button>
                    </Tooltip>
                    <Tooltip label="Execute all">
                      <button className="h-7 w-7 flex items-center justify-center text-white hover:opacity-70">
                        <Play size={15} fill="currentColor" />
                      </button>
                    </Tooltip>
                  </>
                )}
                <Tooltip label={planCollapsed ? "Expand plan" : "Collapse plan"}>
                  <button
                    onClick={() => setPlanCollapsed(!planCollapsed)}
                    className="h-7 w-7 flex items-center justify-center text-white hover:opacity-70"
                  >
                    <CollapsePanelLeftIcon size={16} />
                  </button>
                </Tooltip>
              </div>
            </div>

            {!planCollapsed && (
              <div className="flex-1 overflow-auto py-3">
                {planSections.map((section, sectionIndex) => {
                  const isObjective = sectionIndex === 0;
                  const isExpanded = isObjective || expandedSection === sectionIndex;
                  const emptyMessages = ['No alerts configured', 'No reports configured', 'No data collection configured'];
                  const hasContent = section.steps.length > 0 && !emptyMessages.includes(section.steps[0].title);

                  return (
                    <div key={sectionIndex} className="mb-3">
                      <div
                        className="flex items-center gap-2 mb-2 cursor-pointer hover:opacity-80"
                        onClick={() => {
                          if (isObjective) {
                            setActiveTab('exec');
                            setExpandedSection(null);
                          } else {
                            setExpandedSection(isExpanded ? null : sectionIndex);
                            const tabMap = { 1: 'data', 2: 'alerts', 3: 'reports' };
                            if (tabMap[sectionIndex]) setActiveTab(tabMap[sectionIndex]);
                          }
                        }}
                      >
                        {!isObjective && (
                          <ChevronRight size={12} className={`text-white/40 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                        )}
                        <span className="text-xs text-white/40 uppercase tracking-wider font-medium">{section.title}</span>
                        <div className="flex-1 h-px bg-white/10"></div>
                        {!isObjective && hasContent && (
                          <span className="text-xs text-white/30 mr-1">{section.steps.length}</span>
                        )}
                        {sectionIndex > 0 && isExpanded && hasContent && (
                          <Tooltip label={`Execute ${section.title}`}>
                            <button
                              className="w-5 h-5 rounded flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-colors"
                              onClick={(e) => e.stopPropagation()}
                            >
                              <Play size={10} fill="currentColor" />
                            </button>
                          </Tooltip>
                        )}
                      </div>

                      {isExpanded && section.steps.map((step, stepIndex) => (
                        <div key={stepIndex} className="flex gap-3 ml-1">
                          {sectionIndex > 0 && hasContent && (
                            <div className="flex flex-col items-center">
                              <div className="flex-shrink-0 w-4 h-4 rounded-full flex items-center justify-center" style={accentBg}>
                                <Check size={9} className="text-white" strokeWidth={3} />
                              </div>
                              {stepIndex < section.steps.length - 1 && (
                                <div className="w-0.5 flex-1 my-1" style={{ backgroundColor: 'rgba(123, 97, 255, 0.3)' }}></div>
                              )}
                            </div>
                          )}
                          <div className="pb-3">
                            {step.description ? (
                              <>
                                <h4 className="font-medium text-white mb-0.5" style={type.xs}>{step.title}</h4>
                                <p className="text-white/50" style={{ fontSize: '11px', lineHeight: '15px' }}>{step.description}</p>
                              </>
                            ) : (
                              <p className="text-white/80" style={{ fontSize: '11px', lineHeight: '15px' }}>{step.title}</p>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  );
                })}
              </div>
            )}
          </aside>

          {/* Main Content Area */}
          <div className="flex-1 bg-black pl-3 overflow-hidden">
            <div className="h-full bg-white rounded-tl-2xl shadow-lg flex overflow-hidden">
              {/* Center Content */}
              <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                {/* Tabs */}
                <div className="h-12 mt-3 px-6 flex items-center justify-between flex-shrink-0">
                  <div className="flex items-center gap-1">
                    {['Exec Summary', 'Data', 'Alerts', 'Reports'].map((tab, index) => {
                      const tabKey = tab.toLowerCase().replace(' ', '');
                      const isActive = activeTab === (tab === 'Exec Summary' ? 'exec' : tabKey);
                      return (
                        <button
                          key={tab}
                          onClick={() => {
                            setActiveTab(tab === 'Exec Summary' ? 'exec' : tabKey);
                            setExpandedSection(index === 0 ? null : index);
                          }}
                          className={`h-7 px-3 rounded font-medium transition-colors ${
                            isActive ? 'text-white' : 'text-black hover:bg-black/5'
                          }`}
                          style={{ ...(isActive ? accentBg : {}), ...type.sm }}
                        >
                          {tab}
                        </button>
                      );
                    })}
                  </div>
                  <div className="flex items-center gap-2">
                    <input
                      type="text"
                      placeholder="Search..."
                      className="h-8 w-40 px-3 border border-black/20 rounded text-black placeholder-black/40 focus:outline-none focus:border-violet-400"
                      style={type.sm}
                    />
                    <Tooltip label="Export report">
                      <button className="h-8 w-8 flex items-center justify-center text-black hover:bg-black/5 rounded">
                        <Download size={16} />
                      </button>
                    </Tooltip>
                  </div>
                </div>

                {/* Content */}
                <div className="flex-1 overflow-auto px-8 py-6 light-scrollbar">
                  {activeTab === 'exec' && (
                    <article className="max-w-3xl">
                      <h2 className="font-semibold text-black" style={type['2xl']}>{config.agentName}</h2>
                      <p className="text-black/50 mt-1 mb-6" style={type.sm}>
                        {config.team} • {allWorkflows.find(w => w.id === config.workflow)?.name}
                      </p>

                      {/* Objective */}
                      <div className="p-5 rounded-xl border border-black/10 bg-black/[0.02] mb-6">
                        <p className="text-black/60 font-medium text-xs mb-2">Objective</p>
                        <p className="text-black text-sm">{generateObjectiveDescription(config)}</p>
                      </div>

                      {/* Scope Details */}
                      <div className="p-5 rounded-xl border border-black/10 bg-black/[0.02] mb-6">
                        <p className="text-black/60 font-medium text-xs mb-3">Scope</p>
                        <div className="space-y-2">
                          {Object.entries(config.scope).filter(([_, v]) => v.selected && v.values?.length > 0).map(([id, data]) => {
                            const block = scopeBlocksConfig.find(b => b.id === id);
                            return (
                              <div key={id} className="flex items-start gap-2">
                                <span className="text-black/50 text-xs font-medium min-w-24">{block?.label}:</span>
                                <div className="flex flex-wrap gap-1.5">
                                  {data.values.map((val, idx) => (
                                    <span key={idx} className="text-xs px-2 py-0.5 bg-black/5 rounded text-black/80">{val}</span>
                                  ))}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {/* Stats */}
                      <div className="grid grid-cols-3 gap-4">
                        <div className="p-4 rounded-lg bg-black/[0.02]">
                          <p className="text-black/50 text-xs mb-1">Data Steps</p>
                          <p className="text-black font-bold text-lg">{dataSteps.length}</p>
                          <p className="text-black/60 text-xs">scope + enrichment</p>
                        </div>
                        <div className="p-4 rounded-lg bg-black/[0.02]">
                          <p className="text-black/50 text-xs mb-1">Alerts</p>
                          <p className="text-black font-bold text-lg">{config.alerts.length}</p>
                          <p className="text-black/60 text-xs">configured</p>
                        </div>
                        <div className="p-4 rounded-lg bg-black/[0.02]">
                          <p className="text-black/50 text-xs mb-1">Reports</p>
                          <p className="text-black font-bold text-lg">{config.deliverables.length}</p>
                          <p className="text-black/60 text-xs">deliverables</p>
                        </div>
                      </div>
                    </article>
                  )}

                  {activeTab === 'data' && (
                    <div>
                      <h2 className="font-semibold text-black mb-5" style={type['2xl']}>Data Collection</h2>

                      {/* Scope Steps */}
                      {getScopeDataSteps(config.scope).length > 0 && (
                        <div className="mb-6">
                          <p className="text-black/40 text-xs font-semibold uppercase tracking-wider mb-3">Scope Identification</p>
                          <div className="space-y-3">
                            {getScopeDataSteps(config.scope).map((step, index) => (
                              <div key={index} className="p-4 rounded-lg border border-black/10 hover:border-black/20 transition-colors">
                                <div className="flex items-start gap-3">
                                  <div className="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0" style={accentBg}>
                                    <Check size={12} className="text-white" />
                                  </div>
                                  <div className="flex-1">
                                    <p className="font-medium text-black text-sm">{step.title}</p>
                                    <div className="flex flex-wrap gap-1.5 mt-2">
                                      {step.description.split(', ').map((val, idx) => (
                                        <span key={idx} className="text-xs px-2 py-0.5 bg-black/5 rounded text-black/70">{val}</span>
                                      ))}
                                    </div>
                                  </div>
                                  <span className="ml-auto text-xs text-green-600 font-medium">Complete</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Enrichment Steps */}
                      {config.enrichment.length > 0 && (
                        <div>
                          <p className="text-black/40 text-xs font-semibold uppercase tracking-wider mb-3">Enrichment Analysis</p>
                          <div className="space-y-3">
                            {config.enrichment.map((e, index) => {
                              const allItems = Object.values(enrichmentConfig).flatMap(cat => cat.items);
                              const item = allItems.find(i => i.id === e.id);
                              return (
                                <div key={e.id} className="p-4 rounded-lg border border-black/10 hover:border-black/20 transition-colors">
                                  <div className="flex items-center gap-3">
                                    <div className="w-6 h-6 rounded-full flex items-center justify-center" style={accentBg}>
                                      <Check size={12} className="text-white" />
                                    </div>
                                    <div>
                                      <p className="font-medium text-black text-sm">Analyze {item?.label || e.id}</p>
                                      <p className="text-black/50 text-xs">Gather and evaluate {item?.label?.toLowerCase() || e.id} data</p>
                                    </div>
                                    <span className="ml-auto text-xs text-green-600 font-medium">Complete</span>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                  {activeTab === 'alerts' && (
                    <div>
                      <h2 className="font-semibold text-black mb-5" style={type['2xl']}>Alert Monitoring</h2>
                      {config.alerts.length > 0 ? (
                        <div className="space-y-3">
                          {config.alerts.map((alert, index) => (
                            <div key={alert} className="p-4 rounded-lg border border-black/10 hover:border-black/20 transition-colors">
                              <div className="flex items-center gap-3">
                                <div className="w-2 h-2 rounded-full bg-green-500"></div>
                                <div>
                                  <p className="font-medium text-black text-sm">{alert}</p>
                                  <p className="text-black/50 text-xs">Monitoring active</p>
                                </div>
                                <span className="ml-auto text-xs text-green-600 font-medium">Active</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="p-8 rounded-lg border border-dashed border-black/20 text-center">
                          <p className="text-black/40 text-sm">No alerts configured</p>
                          <p className="text-black/30 text-xs mt-1">Alerts were skipped during wizard setup</p>
                        </div>
                      )}
                    </div>
                  )}

                  {activeTab === 'reports' && (
                    <div>
                      <h2 className="font-semibold text-black mb-5" style={type['2xl']}>Report Generation</h2>
                      {config.deliverables.length > 0 ? (
                        <div className="space-y-3">
                          {config.deliverables.map((d, index) => {
                            const allItems = Object.values(deliverablesConfig).flatMap(cat => cat.items);
                            const item = allItems.find(i => i.id === d.id);
                            return (
                              <div key={d.id} className="p-4 rounded-lg border border-black/10 hover:border-black/20 transition-colors">
                                <div className="flex items-center gap-3">
                                  <div className="w-6 h-6 rounded-full flex items-center justify-center" style={accentBg}>
                                    <Check size={12} className="text-white" />
                                  </div>
                                  <div>
                                    <p className="font-medium text-black text-sm">{item?.label || d.id}</p>
                                    <p className="text-black/50 text-xs">Report ready for generation</p>
                                  </div>
                                  <button className="ml-auto text-xs font-medium px-3 py-1.5 rounded-lg" style={{ ...accentBg, color: 'white' }}>
                                    Generate
                                  </button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      ) : (
                        <div className="p-8 rounded-lg border border-dashed border-black/20 text-center">
                          <p className="text-black/40 text-sm">No reports configured</p>
                          <p className="text-black/30 text-xs mt-1">Deliverables were skipped during wizard setup</p>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Chat Panel */}
              <div
                className={`border-l border-black/10 flex flex-col flex-shrink-0 transition-all duration-300 ${chatCollapsed ? 'w-10' : ''}`}
                style={{ width: chatCollapsed ? undefined : '240px' }}
              >
                <div className={`h-12 mt-3 px-4 flex items-center flex-shrink-0 ${chatCollapsed ? 'justify-center px-0' : 'justify-between'}`}>
                  {!chatCollapsed && (
                    <span className="h-7 px-3 rounded text-white font-medium flex items-center" style={{ ...accentBg, ...type.sm }}>
                      Chat
                    </span>
                  )}
                  <div className="flex items-center gap-1">
                    {!chatCollapsed && (
                      <Tooltip label="New chat">
                        <button className="h-7 w-7 flex items-center justify-center text-black hover:opacity-70">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M12 5v14M5 12h14" />
                          </svg>
                        </button>
                      </Tooltip>
                    )}
                    <Tooltip label={chatCollapsed ? "Expand chat" : "Collapse chat"}>
                      <button
                        onClick={() => setChatCollapsed(!chatCollapsed)}
                        className="h-7 w-7 flex items-center justify-center text-black hover:opacity-70"
                      >
                        <CollapsePanelRightIcon size={16} />
                      </button>
                    </Tooltip>
                  </div>
                </div>

                {!chatCollapsed && (
                  <>
                    <div className="flex-1 overflow-auto px-4 py-3 light-scrollbar">
                      <div className="flex flex-col items-center justify-center h-full text-center">
                        <div className="w-12 h-12 rounded-full flex items-center justify-center mb-3" style={{ ...accentBg, opacity: 0.2 }}>
                          <Send size={20} className="text-black/40" />
                        </div>
                        <p className="text-black/40 text-xs">Ask questions about your agent's findings</p>
                      </div>
                    </div>
                    <div className="p-3 border-t border-black/10">
                      <div className="flex items-center gap-2">
                        <input
                          type="text"
                          value={chatInput}
                          onChange={(e) => setChatInput(e.target.value)}
                          placeholder="Ask a question..."
                          className="flex-1 h-9 px-3 border border-black/20 rounded-md text-black placeholder-black/40 focus:outline-none focus:border-violet-400"
                          style={type.sm}
                        />
                        <Tooltip label="Send">
                          <button className="h-9 w-9 flex items-center justify-center text-white rounded-md hover:opacity-90" style={accentBg}>
                            <Send size={16} />
                          </button>
                        </Tooltip>
                      </div>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // MAIN APP COMPONENT
    // ============================================
    function App() {
      // Phase: 'wizard' | 'plan-preview' | 'stream'
      const [phase, setPhase] = useState('wizard');
      const [config, setConfig] = useState({
        team: null,
        workflow: null,
        foundation: '',
        scope: {}, // { blockId: { selected: true, values: ['value1', 'value2'] } }
        entities: { firm: [], drug: [], trial: [] },
        enrichment: [],
        customEnrichment: {},
        alerts: [],
        customAlerts: [],
        alertNotes: {},
        deliverables: [],
        deliverablesScope: '',
        agentName: '',
        foundationApproved: false,
        enrichmentApproved: false,
        alertsApproved: false,
        reportsApproved: false
      });

      const handleWizardComplete = () => {
        setPhase('plan-preview');
      };

      const handleExecute = () => {
        setPhase('stream');
      };

      const handleEditPlan = () => {
        // Go back to wizard with config preserved
        setConfig(prev => ({ ...prev, reportsApproved: false }));
        setPhase('wizard');
      };

      return (
        <div className="h-screen flex flex-col" style={{ fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }}>
          {/* Header */}
          <header className="h-14 px-5 flex items-center justify-between flex-shrink-0" style={darkBgPattern}>
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 rounded-md flex items-center justify-center" style={accentBg}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M12 2L2 7l10 5 10-5-10-5z" />
                  <path d="M2 17l10 5 10-5" />
                  <path d="M2 12l10 5 10-5" />
                </svg>
              </div>
              <span className="font-semibold text-white" style={type.xl}>
                {phase === 'wizard' ? 'New Agent' : config.agentName || 'Agent'}
              </span>
              {phase !== 'wizard' && (
                <span className="text-xs text-white/40 ml-2">
                  {phase === 'plan-preview' ? 'Review Plan' : 'Executing'}
                </span>
              )}
            </div>
            <div className="flex items-center gap-3">
              {phase !== 'wizard' && (
                <Tooltip label="Share">
                  <button className="h-8 px-3 bg-white/10 border border-white/20 rounded-md font-medium text-white hover:bg-white/20" style={type.sm}>
                    Share
                  </button>
                </Tooltip>
              )}
              <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-medium" style={{ ...accentBg, ...type.xs }}>
                U
              </div>
            </div>
          </header>

          {/* Main Content */}
          <div className="flex-1 flex overflow-hidden">
            {phase === 'wizard' && (
              <div className="flex-1">
                <Wizard
                  config={config}
                  setConfig={setConfig}
                  onComplete={handleWizardComplete}
                  minimized={false}
                />
              </div>
            )}

            {phase === 'plan-preview' && (
              <>
                {/* Minimized Wizard */}
                <Wizard
                  config={config}
                  setConfig={setConfig}
                  onComplete={handleWizardComplete}
                  minimized={true}
                />
                {/* Plan Preview Panel */}
                <div className="flex-1">
                  <PlanPreview
                    config={config}
                    onExecute={handleExecute}
                    onEditPlan={handleEditPlan}
                  />
                </div>
              </>
            )}

            {phase === 'stream' && (
              <StreamView config={config} />
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
